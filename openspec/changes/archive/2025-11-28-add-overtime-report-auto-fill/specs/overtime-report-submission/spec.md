# 加班補報自動填寫功能規格

## ADDED Requirements

### Requirement: 加班補報表單自動填寫

系統 SHALL 能夠根據計算好的加班時數,自動填寫 TECO SSP 系統的「加班補報申請單」表單,減少手動操作並避免錯誤。

#### Scenario: 填寫單筆加班記錄
- **WHEN** 使用者勾選一筆加班記錄並點擊「預覽填寫」
- **THEN** 系統應該:
  - 登入 SSP 系統 FW21001Z.aspx?Kind=B 頁面
  - 提取 ViewState 等必要欄位
  - 填寫加班日期 (txtOT_Datei)
  - 填寫加班內容 (txtOT_Describei)
  - 填寫加班時數 (txtOT_Minutei) 或調休時數 (txtChange_Minutei)
  - 返回填寫結果預覽,不實際送出

#### Scenario: 填寫多筆加班記錄
- **WHEN** 使用者勾選 5 筆加班記錄並點擊「預覽填寫」
- **THEN** 系統應該:
  - 使用「增加列」功能 (lbgvAddRowi) 新增 4 列 (預設已有 1 列)
  - 逐筆填寫所有欄位
  - 正確處理 ViewState 更新
  - 返回所有記錄的填寫預覽

#### Scenario: 送出加班申請 (正式版本)
- **WHEN** 使用者確認填寫內容無誤,點擊「送出申請」
- **THEN** 系統應該:
  - 顯示確認對話框,列出即將送出的記錄
  - 使用者確認後執行表單送出 (btnCommit)
  - 檢查送出結果
  - 顯示成功訊息或錯誤說明

#### Scenario: 預覽模式保護 (Beta 版本)
- **WHEN** 使用者在 Beta 版本點擊「送出申請」
- **THEN** 系統應該:
  - 顯示警告訊息:「此功能尚在測試階段,無法實際送出」
  - 只執行預覽填寫
  - 不執行 btnCommit PostBack

---

### Requirement: 已申請記錄狀態查詢

系統 SHALL 能夠查詢使用者在 SSP 系統中已申請的加班記錄,避免重複申請並顯示申請狀態。

#### Scenario: 查詢當月已申請記錄
- **WHEN** 使用者登入並進入「加班補報」分頁
- **THEN** 系統應該:
  - 自動訪問 FW21003Z.aspx (個人紀錄查詢)
  - 解析 ContentPlaceHolder1_gvFlow211 表格
  - 提取每筆記錄的日期 (lblOT_Date_N) 和狀態 (lblProcess_Flag_Text_N)
  - 返回已申請記錄字典: {日期: 狀態}

#### Scenario: 處理多頁已申請記錄
- **WHEN** 已申請記錄超過一頁 (>10 筆)
- **THEN** 系統應該:
  - 解析分頁資訊 (FlowPagerStyle 表格)
  - 使用 `__doPostBack('ctl00$ContentPlaceHolder1$gvFlow211','Page$N')` 抓取所有頁面
  - 合併所有頁面的記錄
  - 返回完整的已申請記錄列表

#### Scenario: 顯示已申請記錄狀態
- **WHEN** 某日期 (如 2025/11/21) 已申請且狀態為「簽核完成」
- **THEN** 系統應該:
  - 在記錄列表中顯示狀態標籤:「已申請 (簽核完成)」
  - 禁用該記錄的勾選框
  - 變更記錄顏色為灰色或其他區別色
  - 不允許重複送出

---

### Requirement: 加班內容手動編輯

系統 SHALL 允許使用者為每筆加班記錄編輯加班內容說明,而非使用固定範本。

#### Scenario: 編輯單筆記錄的加班內容
- **WHEN** 使用者點擊某筆記錄的加班內容欄位
- **THEN** 系統應該:
  - 顯示可編輯的文字輸入框 (CTkEntry 或 CTkTextbox)
  - 預填預設文字:「加班作業」
  - 允許使用者修改文字
  - 即時儲存修改 (無需額外按鈕)

#### Scenario: 批次套用加班內容
- **WHEN** 使用者輸入範本文字並點擊「套用到所有記錄」
- **THEN** 系統應該:
  - 將範本文字填入所有未申請記錄的加班內容欄位
  - 已申請的記錄不受影響
  - 使用者仍可逐筆修改

#### Scenario: 驗證加班內容必填
- **WHEN** 使用者嘗試送出加班內容為空的記錄
- **THEN** 系統應該:
  - 顯示錯誤訊息:「加班內容為必填欄位」
  - 高亮標示錯誤的記錄
  - 阻止表單送出

---

### Requirement: 加班與調休選擇

系統 SHALL 允許使用者為每筆記錄獨立選擇「加班」或「調休」,預設為「加班」。

#### Scenario: 預設加班選項
- **WHEN** 系統載入加班記錄列表
- **THEN** 系統應該:
  - 所有記錄的「加班」選項預設勾選
  - 「調休」選項未勾選
  - 時數顯示在加班欄位

#### Scenario: 切換到調休
- **WHEN** 使用者點擊某筆記錄的「調休」選項
- **THEN** 系統應該:
  - 取消「加班」勾選
  - 勾選「調休」
  - 時數移動到調休欄位
  - 記錄狀態更新 (is_overtime = False)

#### Scenario: 送出時正確填寫欄位
- **WHEN** 系統填寫表單時遇到「加班」記錄
- **THEN** 系統應該:
  - 填寫 txtOT_Minutei 欄位 (分鐘數)
  - txtChange_Minutei 欄位保持 0 或空白

- **WHEN** 系統填寫表單時遇到「調休」記錄
- **THEN** 系統應該:
  - 填寫 txtChange_Minutei 欄位 (分鐘數)
  - txtOT_Minutei 欄位保持 0 或空白

---

### Requirement: 分頁式使用者介面

系統 SHALL 提供分頁式介面,區分「加班補報」與「本月異常清單」兩個功能模組。

#### Scenario: 登入後顯示加班補報分頁
- **WHEN** 使用者成功登入系統
- **THEN** 系統應該:
  - 預設顯示「加班補報」分頁
  - 自動載入加班記錄列表
  - 自動查詢已申請狀態
  - 顯示統計資訊 (總筆數、總時數)

#### Scenario: 切換到本月異常清單
- **WHEN** 使用者點擊「本月異常清單」分頁
- **THEN** 系統應該:
  - 顯示原有的出勤報表表格
  - 保留所有現有功能 (複製、匯出 Excel、排序)
  - 顯示統計卡片 (總筆數、總時數、平均、最高)

#### Scenario: 分頁狀態保持
- **WHEN** 使用者在「加班補報」分頁編輯記錄後切換到「本月異常清單」
- **THEN** 系統應該:
  - 保留編輯狀態 (不清空)
  - 切換回「加班補報」時恢復原狀態
  - 不重新載入資料 (除非使用者點擊「重新整理」)

---

### Requirement: 記錄選擇與批次操作

系統 SHALL 允許使用者勾選要申請的記錄,並提供批次操作功能。

#### Scenario: 勾選單筆記錄
- **WHEN** 使用者勾選一筆加班記錄
- **THEN** 系統應該:
  - 記錄選擇狀態更新 (is_selected = True)
  - 更新底部統計:「已選擇 1 筆,共 1.5 小時」
  - 啟用「預覽填寫」和「送出申請」按鈕

#### Scenario: 全選記錄
- **WHEN** 使用者點擊「全選」按鈕
- **THEN** 系統應該:
  - 勾選所有未申請的記錄
  - 已申請的記錄保持禁用狀態
  - 更新底部統計

#### Scenario: 取消全選
- **WHEN** 使用者點擊「取消全選」按鈕
- **THEN** 系統應該:
  - 取消所有記錄的勾選
  - 禁用「預覽填寫」和「送出申請」按鈕
  - 統計顯示:「已選擇 0 筆」

#### Scenario: 刪除記錄
- **WHEN** 使用者選擇某筆記錄並點擊「刪除」
- **THEN** 系統應該:
  - 顯示確認對話框:「確定要刪除此記錄嗎?」
  - 使用者確認後從列表移除
  - 不影響 SSP 系統 (僅本地移除)
  - 更新統計資訊

---

### Requirement: 錯誤處理與狀態提示

系統 SHALL 提供清晰的錯誤訊息和操作狀態提示,確保使用者了解操作結果。

#### Scenario: 網路連線失敗
- **WHEN** 系統嘗試查詢已申請記錄但網路中斷
- **THEN** 系統應該:
  - 顯示錯誤訊息:「無法連線到 SSP 系統,請檢查網路」
  - 允許使用者重試
  - 不清空已載入的資料

#### Scenario: ViewState 解析失敗
- **WHEN** SSP 系統更新導致 ViewState 欄位找不到
- **THEN** 系統應該:
  - 記錄詳細錯誤日誌
  - 顯示錯誤訊息:「表單解析失敗,可能是系統更新,請聯絡開發者」
  - 提供降級方案:開啟瀏覽器手動填寫

#### Scenario: 部分記錄填寫失敗
- **WHEN** 系統填寫 5 筆記錄但第 3 筆失敗
- **THEN** 系統應該:
  - 繼續處理剩餘記錄
  - 顯示結果摘要:「成功 4 筆,失敗 1 筆」
  - 列出失敗的記錄與原因
  - 允許重試失敗的記錄

#### Scenario: 操作進度顯示
- **WHEN** 系統正在填寫多筆記錄
- **THEN** 系統應該:
  - 顯示進度條:「正在填寫 3/5...」
  - 禁用操作按鈕,防止重複點擊
  - 允許使用者取消操作
  - 完成後恢復按鈕狀態

---

### Requirement: 預覽與確認機制

系統 SHALL 提供預覽功能,讓使用者在送出前確認填寫內容正確。

#### Scenario: 預覽填寫結果
- **WHEN** 使用者勾選記錄並點擊「預覽填寫」
- **THEN** 系統應該:
  - 在背景執行填寫邏輯 (不送出)
  - 顯示預覽對話框,列出所有欄位值
  - 顯示表單 HTML 快照 (可選)
  - 提供「返回編輯」和「確認送出」按鈕

#### Scenario: 確認送出對話框
- **WHEN** 使用者點擊「送出申請」
- **THEN** 系統應該:
  - 顯示確認對話框
  - 列出即將送出的記錄 (日期、內容、時數、類型)
  - 顯示警告:「此操作將實際送出到 SSP 系統,無法撤回」
  - 提供「取消」和「確定送出」按鈕

#### Scenario: 送出後結果確認
- **WHEN** 系統成功送出加班申請
- **THEN** 系統應該:
  - 顯示成功訊息:「已成功送出 5 筆加班申請」
  - 自動重新整理已申請記錄
  - 更新記錄狀態為「已申請 (簽核中)」
  - 禁用已送出記錄的勾選框

---

### Requirement: 加班內容範本管理

系統 SHALL 允許使用者管理「套用範本」清單,並將自訂範本持久儲存供後續使用。

#### Scenario: 編輯範本清單
- **WHEN** 使用者點擊「管理範本」
- **THEN** 系統應該:
  - 顯示範本管理對話框
  - 以換行分隔列出目前的範本文字
  - 允許使用者新增、修改或刪除範本
  - 儲存變更後更新下拉選單

#### Scenario: 套用自訂範本
- **WHEN** 使用者在「套用範本」下拉選單選取自訂範本
- **THEN** 系統應該:
  - 將範本文字套用到已勾選的記錄 (若無勾選則套用至全部未送出記錄)
  - 保留範本清單變更,關閉程式並重新啟動後仍然有效
